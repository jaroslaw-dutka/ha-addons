name: Update Home Assistant Addons

on:
  schedule:
    - cron: '0 8 * * *'  # Daily at 8 AM UTC
  workflow_dispatch:  # Allow manual trigger

jobs:
  update:
    runs-on: ubuntu-latest
    name: Update addons
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install semver for version comparison
        run: npm install -g semver

      - name: Check for addon updates
        id: check-updates
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: .github/scripts/check-updates.sh

      - name: Create Pull Request
        if: steps.check-updates.outputs.changes_made == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            chore: update addons to latest versions
            
            ${{ steps.check-updates.outputs.updated_addons }}
          title: 'chore: update addons to latest versions'
          body: |
            ## ðŸš€ Addon Updates Available
            
            This PR updates the following addons to their latest upstream versions:
            
            ${{ steps.check-updates.outputs.updated_addons }}
            
            ### ðŸ“‹ Changes Made
            - âœ… Updated version numbers in `config.json` files
            - âœ… Updated `CHANGELOG.md` files with upstream release notes
            - âœ… All changes are based on official GitHub releases
            
            ### ðŸ¤– Automation Details
            - Source: GitHub Releases API
            - Triggered: ${{ github.event_name }}
            - Generated: ${{ github.run_id }}
            
            ---
            *This PR was automatically generated by GitHub Actions*
          branch: update-addons-${{ github.run_number }}
          delete-branch: true
          draft: false